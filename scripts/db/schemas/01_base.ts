/**
 * Base Security Schema
 * Creates the core tables for authentication and authorization.
 */
export const BASE_SCHEMA = [
    // Schema
    `create schema if not exists security;`,

    // Profiles table
    `create table if not exists security.profiles (
        id bigint generated by default as identity primary key,
        name text not null unique
    );`,

    // Users table
    `create table if not exists security.users (
        id bigint generated by default as identity primary key,
        username text not null unique,
        password_hash text not null,
        profile_id bigint not null references security.profiles(id),
        is_active boolean not null default true,
        created_at timestamptz not null default now(),
        updated_at timestamptz not null default now(),
        last_login_at timestamptz
    );`,

    // User-Profile mapping
    `create table if not exists security.user_profiles (
        user_id bigint not null references security.users(id) on delete cascade,
        profile_id bigint not null references security.profiles(id) on delete cascade,
        assigned_at timestamptz not null default now(),
        primary key (user_id, profile_id)
    );`,

    // Objects (Business Objects)
    `create table if not exists security.objects (
        id bigint generated by default as identity primary key,
        name text not null unique
    );`,

    // Methods (Transactions)
    `create table if not exists security.methods (
        id bigint generated by default as identity primary key,
        object_id bigint not null references security.objects(id) on delete cascade,
        name text not null,
        tx integer not null,
        constraint uq_method_object unique (object_id, name),
        constraint uq_method_tx unique (tx),
        constraint ck_method_tx_positive check (tx > 0)
    );`,

    // Permission mapping
    `create table if not exists security.permission_methods (
        profile_id bigint not null references security.profiles(id) on delete cascade,
        method_id bigint not null references security.methods(id) on delete cascade,
        primary key (profile_id, method_id)
    );`,

    // Indexes
    `create index if not exists ix_user_profiles_profile_id on security.user_profiles(profile_id);`,
    `create index if not exists ix_methods_object_id on security.methods(object_id);`,
    `create index if not exists ix_permission_methods_method_id on security.permission_methods(method_id);`,
]
