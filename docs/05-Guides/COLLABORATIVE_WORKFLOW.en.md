# ğŸ¤ Collaborative Development Guide

This guide details how to use the **Database CLI** (`pnpm run db`) to keep the database synchronized across your team. It's the essential document to avoid the classic "It works on my machine!" problem.

---

## 1. The Classic Problem

### Nightmare Scenario

```
Day 1: Pedro creates a "products" table manually in pgAdmin
Day 2: Pedro pushes code that uses the "products" table
Day 3: Juan does git pull, runs the app and... ğŸ’¥
       "ERROR: relation 'products' does not exist"
```

### Why Does This Happen?

- The database is **not in Git**
- Manual changes in pgAdmin are **not shared**
- Each developer has a **different copy** of the schema

---

## 2. The Solution: Schema as Code

> **Golden Rule**: Code is the single source of truth for the database.

In ToProccess, all database changes are defined in TypeScript files under `scripts/db/schemas/`. When any developer runs `pnpm run db sync`, their local database is automatically updated.

```
scripts/db/schemas/
â”œâ”€â”€ 01_base.ts          # System tables (security, sessions)
â”œâ”€â”€ 10_users_extended.ts # User extensions
â”œâ”€â”€ 20_auth.ts          # Authentication (optional)
â”œâ”€â”€ 50_products.ts      # â† YOUR TABLES GO HERE
â””â”€â”€ 90_audit.ts         # Auditing
```

---

## 3. Daily Workflow

### Starting the Day

```bash
# 1. Get team changes
git pull origin main

# 2. Sync database
pnpm run db sync

# 3. Sync BO methods
pnpm run db bo

# 4. Start working
pnpm run dev
```

> ğŸ’¡ **Tip**: Create an alias `alias sync="git pull && pnpm run db sync && pnpm run db bo"` to do this in one command.

### Creating a New Table

1. **Create the schema file**:

```bash
# Create scripts/db/schemas/50_products.ts
```

```typescript
export const sql = [
    `CREATE TABLE IF NOT EXISTS products (
        product_id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        name TEXT NOT NULL,
        price INTEGER NOT NULL,
        stock INTEGER DEFAULT 0,
        created_at TIMESTAMP DEFAULT NOW()
    );`,

    `CREATE INDEX IF NOT EXISTS idx_products_name 
     ON products(name);`,
]
```

2. **Apply the schema**:

```bash
pnpm run db sync
```

3. **Verify it works**:

```bash
pnpm run verify
```

4. **Push to Git**:

```bash
git add scripts/db/schemas/50_products.ts
git commit -m "feat(db): add products table"
git push
```

### Making a Pull Request

```bash
# Verify your schemas are idempotent
pnpm run db sync --dry-run

# Make sure everything passes
pnpm run verify
```

---

## 4. Anatomy of a Schema File

```typescript
// scripts/db/schemas/50_my_module.ts

export const sql = [
    // 1. ALWAYS use IF NOT EXISTS
    `CREATE TABLE IF NOT EXISTS my_table (
        id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        name TEXT NOT NULL
    );`,

    // 2. Indexes are also idempotent
    `CREATE INDEX IF NOT EXISTS idx_my_table_name 
     ON my_table(name);`,

    // 3. New columns (ALTER TABLE)
    `DO $$
     BEGIN
         IF NOT EXISTS (
             SELECT 1 FROM information_schema.columns 
             WHERE table_name = 'my_table' AND column_name = 'email'
         ) THEN
             ALTER TABLE my_table ADD COLUMN email TEXT;
         END IF;
     END $$;`,
]
```

### Naming Conventions

| Prefix | Purpose                        |
| ------ | ------------------------------ |
| `01_`  | System tables (security, core) |
| `10_`  | User extensions                |
| `20_`  | Authentication                 |
| `50_`  | Business tables (your domain)  |
| `90_`  | Auditing, logs                 |

> **Important**: Files are executed in **alphabetical order**. Use numeric prefixes to control dependencies.

---

## 5. Business Object Synchronization

### The Methods Problem

When you create a new method in a BO:

```typescript
// BO/Product/ProductBO.ts
class ProductBO extends BaseBO {
    async list() { ... }
    async create() { ... }   // â† NEW METHOD
}
```

That method needs:

1. A record in `security.methods` (with `tx` number)
2. Permissions in `security.permission_methods`

### The Solution: `pnpm run db bo`

```bash
pnpm run db bo
```

This automatically:

1. Scans all BOs in `BO/`
2. Detects public `async` methods
3. Registers new ones in the DB
4. Assigns `tx` numbers automatically

### Detect Orphaned Methods

If someone deleted a method from code but it's still in DB:

```bash
pnpm run db bo
# âš ï¸ Found 2 orphaned methods:
#    â€¢ ProductBO.oldMethod (tx: 150)
```

### Clean Up Orphaned Methods

```bash
# First, see what would be deleted (dry-run)
pnpm run db bo --prune --dry-run

# If you're sure, delete
pnpm run db bo --prune
```

---

## 6. Essential Commands

| Situation         | Command                                            |
| ----------------- | -------------------------------------------------- |
| **Start of day**  | `git pull && pnpm run db sync && pnpm run db bo`   |
| **New table**     | Create file in `schemas/`, then `pnpm run db sync` |
| **New BO method** | `pnpm run db bo`                                   |
| **Verify state**  | `pnpm run db bo --dry-run`                         |
| **Clean orphans** | `pnpm run db bo --prune`                           |
| **Total reset**   | `pnpm run db reset --yes`                          |

---

## 7. Repository Structure (Large Teams)

For separate Backend + Frontend teams:

```
my-company/
â”œâ”€â”€ my-app-backend/   â† ToProccess (API)
â”‚   â”œâ”€â”€ scripts/db/schemas/
â”‚   â”œâ”€â”€ BO/
â”‚   â””â”€â”€ src/
â”‚
â””â”€â”€ my-app-frontend/  â† React/Vue/Angular
    â””â”€â”€ src/
```

### Flow for Backend Developer

```bash
cd my-app-backend
git pull
pnpm run db sync
pnpm run db bo
pnpm run dev
```

### Flow for Frontend Developer

**Option A: Backend in Docker (Recommended)**

```bash
cd my-app-backend
docker-compose up -d
# Forget about backend, focus on frontend
```

**Option B: Local Backend**

```bash
cd my-app-backend
git pull
pnpm run db sync
pnpm run dev
# In another terminal
cd my-app-frontend
pnpm run dev
```

---

## 8. CI/CD: Automation

In your GitHub Actions / GitLab CI pipeline:

```yaml
# .github/workflows/ci.yml
jobs:
    test:
        steps:
            - uses: actions/checkout@v4

            - name: Start PostgreSQL
              run: docker-compose up -d postgres

            - name: Install dependencies
              run: pnpm ci

            - name: Sync database
              run: pnpm run db sync -- --yes

            - name: Register BOs
              run: pnpm run db bo -- --yes

            - name: Run tests
              run: pnpm run verify
```

---

## 9. Troubleshooting

### "Relation does not exist"

```
ERROR: relation "my_table" does not exist
```

**Cause**: The table doesn't exist in your local DB.

**Solution**:

```bash
pnpm run db sync
```

### "Duplicate key value"

```
ERROR: duplicate key value violates unique constraint
```

**Cause**: Trying to insert a record that already exists.

**Solution**: Use `ON CONFLICT DO NOTHING` or `INSERT ... ON CONFLICT DO UPDATE`.

### "Column already exists"

**Cause**: Your `ALTER TABLE ADD COLUMN` isn't idempotent.

**Solution**: Wrap in `DO $$ ... END $$;` with verification.

---

## 10. Best Practices

### âœ… Do

- Use `IF NOT EXISTS` always
- Run `pnpm run db sync` after every `git pull`
- Keep schema files small and focused
- Use consistent numeric prefixes

### âŒ Don't

- Create tables manually in pgAdmin
- Modify existing tables without schema files
- Share SQL dumps via Slack/email
- Use `DROP TABLE` without protection

---

## 11. Visual Summary

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Pedro creates  â”‚     â”‚   Juan does     â”‚     â”‚   Maria does    â”‚
â”‚   50_orders.ts  â”‚â”€â”€â”€â”€â–¶â”‚   git pull      â”‚â”€â”€â”€â”€â–¶â”‚   git pull      â”‚
â”‚                 â”‚     â”‚   pnpm run db    â”‚     â”‚   pnpm run db    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                      â”‚                       â”‚
         â–¼                      â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     GIT (Code + Schemas)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                      â”‚                       â”‚
         â–¼                      â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Pedro's DB     â”‚     â”‚   Juan's DB     â”‚     â”‚   Maria's DB    â”‚
â”‚   âœ… orders     â”‚     â”‚   âœ… orders     â”‚     â”‚   âœ… orders     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## See Also

- [Database CLI (full reference)](../01-Getting-Started/CLI_DB.en.md)
- [BO Generator](../01-Getting-Started/CLI_BO.en.md)
- [Security System](../02-Architecture/SECURITY_SYSTEM.en.md)
