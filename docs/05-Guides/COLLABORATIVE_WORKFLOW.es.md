# ğŸ¤ GuÃ­a de Desarrollo Colaborativo

Esta guÃ­a detalla cÃ³mo utilizar el **CLI de Base de Datos** (`pnpm run db`) para mantener la base de datos sincronizada en todo el equipo. Es el documento esencial para evitar el clÃ¡sico problema de "Â¡En mi mÃ¡quina funciona!".

---

## 1. El Problema ClÃ¡sico

### Escenario de Pesadilla

```
DÃ­a 1: Pedro crea una tabla "productos" manualmente en pgAdmin
DÃ­a 2: Pedro sube cÃ³digo que usa la tabla "productos"
DÃ­a 3: Juan hace git pull, corre la app y... ğŸ’¥
       "ERROR: relation 'productos' does not exist"
```

### Â¿Por QuÃ© Pasa?

- La base de datos **no estÃ¡ en Git**
- Los cambios manuales en pgAdmin **no se comparten**
- Cada desarrollador tiene **una copia diferente** del esquema

---

## 2. La SoluciÃ³n: Schema as Code

> **Regla de Oro**: El cÃ³digo es la Ãºnica verdad de la base de datos.

En ToProccess, todos los cambios de base de datos se definen en archivos TypeScript. Cuando cualquier desarrollador ejecuta `pnpm run db sync` o `pnpm run db seed`, su base de datos local se actualiza automÃ¡ticamente.

```
migrations/
â”œâ”€â”€ ddl/                  # DefiniciÃ³n de Datos (Esquemas)
â”‚   â”œâ”€â”€ 01_base.ts        # Tablas del sistema (security, sessions)
â”‚   â”œâ”€â”€ 10_users_ext.ts   # Extensiones de usuarios
â”‚   â””â”€â”€ 50_productos.ts   # â† TUS TABLAS VAN AQUÃ
â””â”€â”€ dml/                  # ManipulaciÃ³n de Datos (Semillas)
    â”œâ”€â”€ 91_data_security_profiles.ts
    â””â”€â”€ 98_data_security_user_profile.ts
```

---

## 3. Flujo de Trabajo Diario

### Al Empezar el DÃ­a

```bash
# 1. Obtener cambios del equipo
git pull origin main

# 2. Sincronizar base de datos
pnpm run db sync

# 3. Sincronizar mÃ©todos de BOs
pnpm run db bo

# 4. Empezar a trabajar
pnpm run dev
```

> ğŸ’¡ **Tip**: Crea un alias `alias sync="git pull && pnpm run db sync && pnpm run db bo"` para hacer esto en un solo comando.

### Al Crear una Nueva Tabla

1. **Crea el archivo de esquema**:

```bash
# Crea migrations/ddl/50_productos.ts
```

```typescript
export const sql = [
    `CREATE TABLE IF NOT EXISTS productos (
        producto_id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        nombre TEXT NOT NULL,
        precio INTEGER NOT NULL,
        stock INTEGER DEFAULT 0,
        created_at TIMESTAMP DEFAULT NOW()
    );`,

    `CREATE INDEX IF NOT EXISTS idx_productos_nombre 
     ON productos(nombre);`,
]
```

2. **Aplica el esquema**:

```bash
pnpm run db sync
```

3. **Verifica que funciona**:

```bash
pnpm run verify
```

4. **Sube a Git**:

```bash
git add migrations/ddl/50_productos.ts
git commit -m "feat(db): add productos table"
git push
```

### Al Hacer Pull Request

```bash
# Verifica que tus esquemas son idempotentes
pnpm run db sync --dry-run

# AsegÃºrate de que todo pasa
pnpm run verify
```

---

## 4. AnatomÃ­a de un Archivo de Esquema

```typescript
// migrations/ddl/50_mi_modulo.ts

export const sql = [
    // 1. SIEMPRE usa IF NOT EXISTS
    `CREATE TABLE IF NOT EXISTS mi_tabla (
        id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        nombre TEXT NOT NULL
    );`,

    // 2. Los Ã­ndices tambiÃ©n son idempotentes
    `CREATE INDEX IF NOT EXISTS idx_mi_tabla_nombre 
     ON mi_tabla(nombre);`,

    // 3. Columnas nuevas (ALTER TABLE)
    `DO $$
     BEGIN
         IF NOT EXISTS (
             SELECT 1 FROM information_schema.columns 
             WHERE table_name = 'mi_tabla' AND column_name = 'email'
         ) THEN
             ALTER TABLE mi_tabla ADD COLUMN email TEXT;
         END IF;
     END $$;`,
]
```

### Convenciones de Nombrado

| Prefijo | PropÃ³sito                           |
| ------- | ----------------------------------- |
| `01_`   | Tablas del sistema (security, core) |
| `10_`   | Extensiones de usuarios             |
| `20_`   | AutenticaciÃ³n                       |
| `50_`   | Tablas de negocio (tu dominio)      |
| `90_`   | AuditorÃ­a, logs                     |

> **Importante**: Los archivos se ejecutan en **orden alfabÃ©tico**. Usa prefijos numÃ©ricos para controlar dependencias.

---

## 5. SincronizaciÃ³n de Business Objects

### El Problema de los MÃ©todos

Cuando creas un nuevo mÃ©todo en un BO:

```typescript
// BO/Producto/ProductoBO.ts
class ProductoBO extends BaseBO {
    async listar() { ... }
    async crear() { ... }   // â† NUEVO MÃ‰TODO
}
```

Ese mÃ©todo necesita:

1. Un registro en `security.methods` (con nÃºmero `tx`)
2. Permisos en `security.permission_methods`

### La SoluciÃ³n: `pnpm run db bo`

```bash
pnpm run db bo
```

Esto automÃ¡ticamente:

1. Escanea todos los BOs en `BO/`
2. Detecta mÃ©todos `async` pÃºblicos
3. Registra los nuevos en la BD
4. Asigna nÃºmeros `tx` automÃ¡ticamente

### Detectar MÃ©todos HuÃ©rfanos

Si alguien eliminÃ³ un mÃ©todo del cÃ³digo pero sigue en la BD:

```bash
pnpm run db bo
# âš ï¸ Found 2 orphaned methods:
#    â€¢ ProductoBO.metodoViejo (tx: 150)
```

### Limpiar MÃ©todos HuÃ©rfanos

```bash
# Primero, ver quÃ© se eliminarÃ­a (dry-run)
pnpm run db bo --prune --dry-run

# Si estÃ¡s seguro, eliminar
pnpm run db bo --prune
```

---

## 6. Comandos Esenciales

| SituaciÃ³n             | Comando                                                                 |
| --------------------- | ----------------------------------------------------------------------- |
| **Inicio del dÃ­a**    | `git pull && pnpm run db sync && pnpm run db seed -y && pnpm run db bo` |
| **Nueva tabla**       | Crear archivo en `migrations/ddl/`, luego `pnpm run db sync`            |
| **Nuevo mÃ©todo BO**   | `pnpm run db bo`                                                        |
| **Verificar estado**  | `pnpm run db bo --dry-run`                                              |
| **Limpiar huÃ©rfanos** | `pnpm run db bo --prune`                                                |
| **Reset total**       | `pnpm run db reset --yes`                                               |

---

## 7. Estructura de Repositorios (Equipos Grandes)

Para equipos Backend + Frontend separados:

```
mi-company/
â”œâ”€â”€ mi-app-backend/   â† ToProccess (API)
â”‚   â”œâ”€â”€ migrations/   â† (ddl y dml)
â”‚   â”œâ”€â”€ BO/
â”‚   â””â”€â”€ src/
â”‚
â””â”€â”€ mi-app-frontend/  â† React/Vue/Angular
    â””â”€â”€ src/
```

### Flujo para Desarrollador Backend

```bash
cd mi-app-backend
git pull
pnpm run db sync
pnpm run db bo
pnpm run dev
```

### Flujo para Desarrollador Frontend

**OpciÃ³n A: Backend en Docker (Recomendado)**

```bash
cd mi-app-backend
docker-compose up -d
# Olvidarse del backend, enfocarse en frontend
```

**OpciÃ³n B: Backend Local**

```bash
cd mi-app-backend
git pull
pnpm run db sync
pnpm run dev
# En otra terminal
cd mi-app-frontend
pnpm run dev
```

---

## 8. CI/CD: AutomatizaciÃ³n

En tu pipeline de GitHub Actions / GitLab CI:

```yaml
# .github/workflows/ci.yml
jobs:
    test:
        steps:
            - uses: actions/checkout@v4

            - name: Start PostgreSQL
              run: docker-compose up -d postgres

            - name: Install dependencies
              run: pnpm ci

            - name: Sync database
              run: pnpm run db sync -- --yes

            - name: Register BOs
              run: pnpm run db bo -- --yes

            - name: Run tests
              run: pnpm run verify
```

---

## 9. ResoluciÃ³n de Problemas

### "Relation does not exist"

```
ERROR: relation "mi_tabla" does not exist
```

**Causa**: La tabla no existe en tu BD local.

**SoluciÃ³n**:

```bash
pnpm run db sync
```

### "Duplicate key value"

```
ERROR: duplicate key value violates unique constraint
```

**Causa**: Intentas insertar un registro que ya existe.

**SoluciÃ³n**: Usa `ON CONFLICT DO NOTHING` o `INSERT ... ON CONFLICT DO UPDATE`.

### "Column already exists"

**Causa**: Tu `ALTER TABLE ADD COLUMN` no es idempotente.

**SoluciÃ³n**: Envuelve en `DO $$ ... END $$;` con verificaciÃ³n.

---

## 10. Mejores PrÃ¡cticas

### âœ… Hacer

- Usar `IF NOT EXISTS` siempre
- Ejecutar `pnpm run db sync` despuÃ©s de cada `git pull`
- Mantener los archivos de esquema pequeÃ±os y enfocados
- Usar prefijos numÃ©ricos consistentes

### âŒ No Hacer

- Crear tablas manualmente en pgAdmin
- Modificar tablas existentes sin archivos de esquema
- Compartir dumps SQL por Slack/email
- Usar `DROP TABLE` sin protecciÃ³n

---

## 11. Resumen Visual

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Pedro crea    â”‚     â”‚   Juan hace     â”‚     â”‚   MarÃ­a hace    â”‚
â”‚   50_orders.ts  â”‚â”€â”€â”€â”€â–¶â”‚   git pull      â”‚â”€â”€â”€â”€â–¶â”‚   git pull      â”‚
â”‚                 â”‚     â”‚   pnpm run db    â”‚     â”‚   pnpm run db    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                      â”‚                       â”‚
         â–¼                      â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     GIT (CÃ³digo + Esquemas)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                      â”‚                       â”‚
         â–¼                      â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   BD de Pedro   â”‚     â”‚   BD de Juan    â”‚     â”‚   BD de MarÃ­a   â”‚
â”‚   âœ… orders     â”‚     â”‚   âœ… orders     â”‚     â”‚   âœ… orders     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Ver TambiÃ©n

- [CLI de Base de Datos (referencia completa)](../01-Getting-Started/CLI_DB.es.md)
- [Generador de BOs](../01-Getting-Started/CLI_BO.es.md)
- [Sistema de Seguridad](../02-Architecture/SECURITY_SYSTEM.es.md)
